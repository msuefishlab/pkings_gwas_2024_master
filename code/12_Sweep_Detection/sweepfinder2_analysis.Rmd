---
title: "SweepFinder2 Genome-Wide Sweep Analysis"
author: "Jason Gallant Lab"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    code_folding: hide
    theme: flatly
    fig_width: 14
    fig_height: 10
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 14, fig.height = 10)
library(tidyverse)
library(scales)
library(knitr)

root <- rprojroot::find_root(".git/index")
knitr::opts_knit$set(root.dir = root)

# ggplot2 theme
theme_set(theme_bw(base_size = 10))
```

# Overview

This notebook analyzes genome-wide selective sweep patterns using **SweepFinder2** Composite Likelihood Ratio (CLR) statistics. We compare CLR values in GWAS peaks versus genome-wide background to determine how "sweepy" our GWAS loci are relative to the rest of the genome.

**Populations analyzed:**

- **BP1**: Bambomo BP phenotypes
- **TP1**: Ipassa/Bengue TP phenotypes
- **BP2**: Bikagala/Bavavela BP phenotypes
- **TP2**: Douvalou/Douengi TP phenotypes
- **BP3**: Biroundou BP phenotypes

**GWAS Peaks:** 6 major peaks on chr6, chr8, chr13, chr16, chr17, chr24

---

# 1. Load Data

## 1.1 Genome-Wide CLR Distributions

```{r load_genome_wide}
cat("Loading genome-wide CLR distributions...\n")

pops <- c("BP1", "TP1", "BP2", "TP2", "BP3")
clr_data_list <- list()

for (pop in pops) {
  file <- file.path(root, "output_data/12_Sweep_Detection/sweepfinder2/merged",
                    paste0(pop, ".genome_wide_clr.txt"))

  if (file.exists(file)) {
    cat("  Loading:", pop, "\n")
    clr_data_list[[pop]] <- read_tsv(file, show_col_types = FALSE) %>%
      mutate(population = pop)
  } else {
    warning("File not found: ", file)
  }
}

# Combine all populations
clr_data <- bind_rows(clr_data_list)

cat("\nGenome-wide CLR data:\n")
cat("  Total positions:", nrow(clr_data), "\n")
cat("  Populations:", paste(unique(clr_data$population), collapse = ", "), "\n")
cat("  Chromosomes:", length(unique(clr_data$chromosome)), "\n")
```

## 1.2 Peak-Specific CLR Values

```{r load_peaks}
cat("\nLoading peak-specific CLR values...\n")

peak_clr <- read_tsv(
  file.path(root, "output_data/12_Sweep_Detection/sweepfinder2/peak_clr_values.txt"),
  show_col_types = FALSE
)

cat("  Peak CLR positions:", nrow(peak_clr), "\n")
cat("  Peaks:", paste(unique(peak_clr$peak), collapse = ", "), "\n")

# Load peak summary
peak_summary <- read_tsv(
  file.path(root, "output_data/12_Sweep_Detection/sweepfinder2/peak_clr_summary.txt"),
  show_col_types = FALSE
)
```

## 1.3 GWAS Peak Definitions

```{r load_peak_defs}
peaks_bed <- read.table(
  file.path(root, "output_data/06_Association/PKINGS_ALL_WOB_EXCLUDED/PKINGS_ALL_WOB_EXCLUDED_PEAKS.bed"),
  col.names = c("chromosome", "start", "end", "peak", "max_log_p", "idx_bp")
)

# Add chr prefix if needed
if (!grepl("^chr", peaks_bed$chromosome[1])) {
  peaks_bed$chromosome <- paste0("chr", peaks_bed$chromosome)
}

kable(peaks_bed, caption = "GWAS Peak Definitions")
```

---

# 2. Genome-Wide CLR Manhattan Plot

## 2.1 Prepare Data for Plotting

```{r prepare_manhattan_data}
cat("Preparing data for Manhattan plot...\n")

# Calculate genome-wide cumulative position for continuous x-axis
# IMPORTANT: Handle cases where only GWAS peak chromosomes are present (chr6, 8, 13, 16, 17, 24)
# vs full genome (chr1-25)

clr_plot_data <- clr_data %>%
  mutate(
    numeric_chr = as.numeric(str_replace_all(chromosome, "chr", ""))
  ) %>%
  arrange(numeric_chr, position)

# Get chromosome info for present chromosomes only
chr_lengths <- clr_plot_data %>%
  group_by(chromosome, numeric_chr) %>%
  summarize(chr_length = max(position), .groups = "drop") %>%
  arrange(numeric_chr) %>%
  mutate(
    chr_start = cumsum(lag(chr_length, default = 0)),
    chr_start = ifelse(is.na(chr_start), 0, chr_start)
  )

# Join back to data
clr_plot_data <- clr_plot_data %>%
  left_join(chr_lengths, by = c("chromosome", "numeric_chr")) %>%
  mutate(
    genome_pos = chr_start + position,
    chr_mid = chr_start + (chr_length / 2)
  )

# Calculate chromosome boundaries and midpoints (using only present chromosomes)
chr_info <- chr_lengths %>%
  mutate(chr_end = chr_start + chr_length) %>%
  select(chromosome, numeric_chr, chr_start, chr_end, chr_length) %>%
  mutate(chr_mid = chr_start + (chr_length / 2))

# Add GWAS peak regions to genome coordinates
peaks_genome <- peaks_bed %>%
  mutate(numeric_chr = as.numeric(str_replace_all(chromosome, "chr", ""))) %>%
  left_join(
    chr_info %>% select(numeric_chr, chr_start),
    by = "numeric_chr"
  ) %>%
  mutate(
    peak_start_genome = chr_start + start,
    peak_end_genome = chr_start + end,
    peak_mid_genome = chr_start + idx_bp
  )

# Normalize alpha values for color gradient
# High 1/alpha (>0.2, i.e., alpha < 5) → red (strong selection)
# Low 1/alpha (<=0.2, i.e., alpha >= 5) → black (weak selection)
clr_plot_data <- clr_plot_data %>%
  mutate(
    inv_alpha = 1 / alpha,
    alpha_norm = pmin(inv_alpha / 0.2, 1),  # Normalize: 1/alpha > 0.2 = 1 (red)
    alpha_norm = pmax(alpha_norm, 0)         # Ensure >= 0
  )

cat(sprintf("  Chromosomes: %s\n", paste(chr_info$numeric_chr, collapse = ", ")))
cat(sprintf("  Total positions: %s\n", format(nrow(clr_plot_data), big.mark = ",")))
```

## 2.2 Manhattan Plot with Population Facets

```{r manhattan_plot}
p_manhattan <- ggplot(clr_plot_data, aes(x = genome_pos, y = CLR)) +
  # Alternating chromosome background shading
  geom_rect(
    data = chr_info %>%
      mutate(chr_index = row_number()) %>%
      filter(chr_index %% 2 == 0),
    aes(xmin = chr_start, xmax = chr_end, ymin = -Inf, ymax = Inf),
    fill = "grey95", alpha = 0.5, inherit.aes = FALSE
  ) +
  # GWAS peak highlighting (blue rectangles)
  geom_rect(
    data = peaks_genome,
    aes(xmin = peak_start_genome, xmax = peak_end_genome,
        ymin = -Inf, ymax = Inf),
    fill = "blue", alpha = 0.5, inherit.aes = FALSE
  ) +
  # CLR points with alpha-based coloring
  geom_point(aes(color = alpha_norm), size = 0.4, alpha = 0.6) +
  # Color gradient: black (low alpha) to red (high alpha > 0.2)
  scale_color_gradient(
    low = "black", high = "red",
    name = "Alpha\n(Selection)",
    guide = guide_colorbar(barwidth = 1, barheight = 10)
  ) +
  # X-axis: chromosome labels at midpoints
  scale_x_continuous(
    breaks = chr_info$chr_mid,
    labels = chr_info$numeric_chr,
    expand = c(0.01, 0)
  ) +
  # Y-axis
  scale_y_continuous(
    expand = expansion(mult = c(0.02, 0.05))
  ) +
  # Facet by population (horizontal panels)
  facet_wrap(~population, ncol = 1, scales = "free_y") +
  # Labels
  labs(
    title = "Genome-Wide Selective Sweep Analysis (SweepFinder2)",
    subtitle = paste0("CLR across ", length(unique(chr_info$chromosome)),
                     " chromosomes | Blue shading = GWAS peaks | ",
                     "Color intensity = Selection strength (1/alpha > 0.2)"),
    x = "Chromosome",
    y = "Composite Likelihood Ratio (CLR)"
  ) +
  # Theme
  theme_bw(base_size = 10) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = 8),
    strip.background = element_rect(fill = "grey90"),
    strip.text = element_text(face = "bold", size = 10),
    legend.position = "right"
  )

# Display plot
p_manhattan

# Save high-resolution version
ggsave(
  file.path(root, "output_data/12_Sweep_Detection/sweepfinder2/clr_manhattan.pdf"),
  p_manhattan,
  width = 14, height = 10, units = "in"
)
ggsave(
  file.path(root, "output_data/12_Sweep_Detection/sweepfinder2/clr_manhattan.png"),
  p_manhattan,
  width = 14, height = 10, units = "in", dpi = 300
)

cat("\nFigures saved:\n")
cat("  PDF: output_data/12_Sweep_Detection/sweepfinder2/clr_manhattan.pdf\n")
cat("  PNG: output_data/12_Sweep_Detection/sweepfinder2/clr_manhattan.png\n")
```

---

# 3. Zoomed Manhattan Plot (Peak Regions)

## 3.1 Extract Peak Region Data

```{r extract_peak_regions}
cat("Extracting ±250kb regions around peak index SNPs...\n")

# Define window size
window_size <- 250000  # 250kb

# Create peak region definitions with windows
peak_regions <- peaks_bed %>%
  mutate(
    region_start = pmax(1, idx_bp - window_size),
    region_end = idx_bp + window_size,
    region_width = region_end - region_start
  )

# Extract CLR data within peak regions
peak_region_data <- clr_data %>%
  inner_join(
    peak_regions %>% select(chromosome, peak, idx_bp, region_start, region_end),
    by = "chromosome"
  ) %>%
  filter(position >= region_start & position <= region_end) %>%
  mutate(
    # Position relative to region start (for cumulative calculation)
    rel_position = position - region_start,
    # Normalize alpha for coloring
    inv_alpha = 1 / alpha,
    alpha_norm = pmin(inv_alpha / 0.2, 1),
    alpha_norm = pmax(alpha_norm, 0)
  )

cat(sprintf("  Extracted %s positions across %d peaks\n",
            format(nrow(peak_region_data), big.mark = ","),
            length(unique(peak_region_data$peak))))
```

## 3.2 Prepare Cumulative Positions Across Peaks

```{r prepare_peak_cumulative}
cat("Calculating cumulative positions across peak regions...\n")

# Get peak region info (width of each ±250kb window)
peak_info <- peak_regions %>%
  arrange(peak) %>%
  mutate(
    peak_start_cum = cumsum(lag(region_width, default = 0)),
    peak_end_cum = peak_start_cum + region_width,
    peak_mid_cum = peak_start_cum + (region_width / 2),
    # GWAS peak boundaries in cumulative space (not the ±250kb window)
    gwas_peak_start_cum = peak_start_cum + (start - region_start),
    gwas_peak_end_cum = peak_start_cum + (end - region_start)
  )

# Join cumulative positions to data
peak_plot_data <- peak_region_data %>%
  left_join(
    peak_info %>% select(peak, peak_start_cum, region_start, idx_bp),
    by = c("peak", "region_start", "idx_bp")
  ) %>%
  mutate(
    # Cumulative genome position across all peak regions
    genome_pos_peak = peak_start_cum + rel_position
  )

# Create peak boundary info for plotting
peak_boundaries <- peak_info %>%
  mutate(peak_index = row_number())

cat(sprintf("  Peak regions span %.2f Mb in cumulative space\n",
            max(peak_boundaries$peak_end_cum) / 1e6))
```

## 3.3 Zoomed Manhattan Plot

```{r zoomed_manhattan_unified, fig.height=10}
p_zoomed <- ggplot(peak_plot_data, aes(x = genome_pos_peak, y = CLR)) +
  # Alternating peak background shading (entire ±250kb windows)
  geom_rect(
    data = peak_boundaries %>% filter(peak_index %% 2 == 0),
    aes(xmin = peak_start_cum, xmax = peak_end_cum, ymin = -Inf, ymax = Inf),
    fill = "grey50", alpha = 0.5, inherit.aes = FALSE
  ) +
  # Blue shading for GWAS peak boundaries (actual peak regions from BED file)
  geom_rect(
    data = peak_boundaries,
    aes(xmin = gwas_peak_start_cum, xmax = gwas_peak_end_cum,
        ymin = -Inf, ymax = Inf),
    fill = "blue", alpha = 0.5, inherit.aes = FALSE
  ) +
  # Index SNP vertical lines
  geom_vline(
    data = peak_boundaries,
    aes(xintercept = peak_start_cum + (idx_bp - region_start)),
    linetype = "dashed", color = "darkblue", size = 0.5
  ) +
  # CLR points with alpha-based coloring
  geom_point(aes(color = alpha_norm), size = 0.5, alpha = 0.7) +
  # Color gradient: black (low alpha) to red (high alpha > 0.2)
  scale_color_gradient(
    low = "black", high = "red",
    name = "Alpha\n(Selection)",
    guide = guide_colorbar(barwidth = 1, barheight = 10)
  ) +
  # X-axis: peak labels at midpoints
  scale_x_continuous(
    breaks = peak_boundaries$peak_mid_cum,
    labels = paste0("Peak ", peak_boundaries$peak, "\n(",
                   peak_boundaries$chromosome, ")"),
    expand = c(0.01, 0)
  ) +
  # Y-axis
  scale_y_continuous(
    expand = expansion(mult = c(0.02, 0.05))
  ) +
  # Facet by population (vertical panels)
  facet_wrap(~population, ncol = 1, scales = "free_y") +
  # Labels
  labs(
    title = "Zoomed Peak Regions (±250kb around Index SNPs)",
    subtitle = paste0(length(unique(peak_boundaries$peak)),
                     " GWAS peaks | Blue shading = GWAS peak boundaries | ",
                     "Dashed lines = Index SNPs | Color = Selection strength (1/alpha > 0.2)"),
    x = "Peak Region",
    y = "Composite Likelihood Ratio (CLR)"
  ) +
  # Theme
  theme_bw(base_size = 10) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = 7, lineheight = 0.8),
    strip.background = element_rect(fill = "grey90"),
    strip.text = element_text(face = "bold", size = 10),
    legend.position = "right"
  )

# Display plot
p_zoomed

# Save high-resolution version
ggsave(
  file.path(root, "output_data/12_Sweep_Detection/sweepfinder2/clr_zoomed_peaks.pdf"),
  p_zoomed,
  width = 14, height = 10, units = "in"
)
ggsave(
  file.path(root, "output_data/12_Sweep_Detection/sweepfinder2/clr_zoomed_peaks.png"),
  p_zoomed,
  width = 14, height = 10, units = "in", dpi = 300
)

cat("\nZoomed peak figures saved:\n")
cat("  PDF: output_data/12_Sweep_Detection/sweepfinder2/clr_zoomed_peaks.pdf\n")
cat("  PNG: output_data/12_Sweep_Detection/sweepfinder2/clr_zoomed_peaks.png\n")
```

---

# 4. Summary Statistics

## 4.1 Peak vs Background CLR

```{r summary_table}
summary_table <- clr_data %>%
  left_join(
    peak_clr %>% distinct(chromosome, position, peak, population),
    by = c("chromosome", "position", "population")
  ) %>%
  mutate(region = ifelse(is.na(peak), "Background", "Peak")) %>%
  group_by(population, region) %>%
  summarize(
    n = n(),
    mean_CLR = mean(CLR, na.rm = TRUE),
    median_CLR = median(CLR, na.rm = TRUE),
    max_CLR = max(CLR, na.rm = TRUE),
    mean_alpha = mean(alpha, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = region,
    values_from = c(n, mean_CLR, median_CLR, max_CLR, mean_alpha),
    names_sep = "_"
  ) %>%
  mutate(
    fold_enrichment = mean_CLR_Peak / mean_CLR_Background
  )

kable(summary_table, digits = 3,
      caption = "Peak vs Background CLR Summary by Population")
```

## 4.2 Interpretation

The Manhattan plot above shows genome-wide CLR values across all chromosomes for each population. Points are colored by 1/alpha from SweepFinder2 (black = low selection strength when 1/alpha ≤ 0.2, red = high selection strength when 1/alpha > 0.2, i.e., alpha < 5). GWAS peaks are highlighted in blue.

**Key observations:**

- CLR values vary across the genome, with some regions showing elevated signals consistent with selective sweeps
- GWAS peaks (blue shading) can be visually compared to the genome-wide background to assess whether they represent extreme sweep signals
- Red points indicate regions with high 1/alpha values (>0.2, i.e., small alpha < 5), suggesting strong selection
- Population-specific patterns reveal whether BP and TP populations show different selection signatures at shared GWAS peaks

---

# 5. Session Info

```{r session_info}
sessionInfo()
```
