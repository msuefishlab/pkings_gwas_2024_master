---
title: "Examination of Signatures of Introgression with DSuite"
output: html_notebook
---

```{r setup}
root <- rprojroot::find_root(".git/index")
knitr::opts_knit$set(root.dir = root)
library(readr)
library(dplyr)
library(stringr)
library(purrr)
library(tidyr)
library(ggplot2)
library(viridis)
library(patchwork)
library(colorspace)
library(scales)


read_bbaa <- function(f, peak_label = NA_character_) {
  df <- read_tsv(f, show_col_types = FALSE, progress = FALSE)
  # Standardize names by position, matching your header
  # 1:P1 2:P2 3:P3 4:D 5:Z 6:p 7:f4ratio 8:BBAA 9:ABBA 10:BABA
  names(df)[1:10] <- c("P1","P2","P3","D","Z","p","f4ratio","BBAA","ABBA","BABA")
  df %>% mutate(Peak = peak_label)
}

row_matches_hyp <- function(P1,P2,P3, pair_a, pair_b, spacer) {
  s <- c(P1,P2,P3)
  all(c(pair_a, pair_b, spacer) %in% s)
}

trio_key <- function(P1,P2,P3) paste(sort(c(P1,P2,P3)), collapse = "|")

hyp_defs <- tribble(
  ~Hypothesis,   ~pair_a, ~pair_b, ~spacer,
  "BP1↔BP2",      "BP1",   "BP2",   "TP1",
  "BP1↔BP3",      "BP1",   "BP3",   "TP2",
  "BP2↔BP3",      "BP2",   "BP3",   "TP2",
  "BP1↔BP_ANC",   "BP1",   "BP_ANC","TP_OUT",
  "BP2↔BP_ANC",   "BP2",   "BP_ANC","TP_OUT",
  "BP3↔BP_ANC",   "BP3",   "BP_ANC","TP_OUT"
)

```


```{r}
peak_files <- list.files(path=file.path(root,"output_data","10_Introgression"), pattern = "^peak_[0-9]+_BBAA\\.txt$", full.names=T)
stopifnot(length(peak_files) > 0)

peaks_raw <- map_dfr(peak_files, function(f) {
  lab<-basename(f)
  lab <- str_remove(lab, "_BBAA\\.txt")  # e.g., "peak_3"
  read_bbaa(f, peak_label = lab)
})

peaks_matched <- hyp_defs %>%
  rowwise() %>%
  do({
    hyp <- .$Hypothesis; a <- .$pair_a; b <- .$pair_b; sp <- .$spacer
    # Keep rows that have {a,b,sp} in any order
    hits <- peaks_raw %>%
      filter(row_matches_hyp(P1,P2,P3, a,b,sp))
    if (nrow(hits) == 0) tibble() else mutate(hits, Hypothesis = hyp, spacer = sp,
                                              pair_a = a, pair_b = b)
  }) %>% ungroup()

peaks_matched <- peaks_matched %>%
  group_by(Peak, Hypothesis) %>%
  mutate(pref = ifelse(P3 == spacer, 1L, 2L)) %>%
  slice_min(pref, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  select(Peak, Hypothesis, P1, P2, P3, D, Z, p, f4ratio, BBAA, ABBA, BABA)

peaks_df <- peaks_matched %>%
  mutate(q = p.adjust(p, method = "BH"),
         sig = case_when(q < 0.05 ~ "q<0.05",
                         q < 0.10 ~ "q<0.10",
                         TRUE ~ "ns"),
         dir = ifelse(D >= 0, "pos", "neg")) %>%
  mutate(Peak = factor(Peak, levels = paste0("peak_", 1:6)),
         Hypothesis = factor(Hypothesis,
           levels = c("BP1↔BP2","BP1↔BP3","BP2↔BP3","BP1↔BP_ANC","BP2↔BP_ANC","BP3↔BP_ANC")))

  gw <- read_tsv(file.path(root, "output_data","10_Introgression","whole_genome_combined_BBAA.txt"), show_col_types = FALSE)
  names(gw)[1:10] <- c("P1","P2","P3","D","Z","p","f4ratio","BBAA","ABBA","BABA")


  gw <- gw %>%
  rowwise() %>%
  mutate(key = paste(sort(c_across(c(P1, P2, P3))), collapse = "|")) %>%
  ungroup() %>%
  select(key, D_gw = D, f4ratio_gw = f4ratio, Z_gw = Z, p_gw = p)

  peaks_df <- peaks_df %>%
  rowwise() %>%
  mutate(key = paste(sort(c_across(c(P1, P2, P3))), collapse = "|")) %>%
  ungroup() %>%
  left_join(gw, by = "key") %>%
  select(-key)

```

```{r}
head(peaks_df)

peaks_df <- peaks_df %>%
  mutate(
    nSNPs = BBAA + ABBA + BABA,
    xlow_info = nSNPs < 200  # threshold of your choice
  )


```

```{r, fig.width=12}

# ensure peak order and hypothesis order (adjust if yours differ)
peaks_df <- peaks_df %>%
  mutate(
    Peak = factor(Peak, levels = paste0("peak_", 1:6)),
    Hypothesis = factor(Hypothesis,
      levels = c("BP1↔BP2","BP1↔BP3","BP2↔BP3","BP1↔BP_ANC","BP2↔BP_ANC","BP3↔BP_ANC"))
  )

# one genome-wide baseline per hypothesis
gw_baseline <- peaks_df %>%
  group_by(Hypothesis) %>%
  summarize(f4ratio_gw = first(f4ratio_gw), .groups = "drop")

#ymax <- max(peaks_df$f4ratio, gw_baseline$f4ratio_gw, na.rm = TRUE) * 1.05
ymax<-1
ggplot(peaks_df, aes(x = Peak, y = f4ratio)) +
  geom_col(width = 0.7, alpha = 0.9) +
  # significance: filled dot for q<0.05, ring for 0.05–0.10
  geom_point(
    data = subset(peaks_df, q < 0.10),
    aes(y = f4ratio + 0.02 * ymax, shape = sig),
    size = 2.6, stroke = 0.7, fill = "white", color = "black"
  ) +
  scale_shape_manual(values = c("q<0.05" = 16, "q<0.10" = 1), guide = "none") +
  # direction of D as triangle at bar top (only for significant cells)
  geom_point(
    data = subset(peaks_df, q < 0.10 & dir == "pos"),
    aes(y = f4ratio + 0.06 * ymax), shape = 24, size = 2.2, fill = "white"
  ) +
  geom_point(
    data = subset(peaks_df, q < 0.10 & dir == "neg"),
    aes(y = f4ratio + 0.06 * ymax), shape = 25, size = 2.2, fill = "white"
  ) +
  # genome-wide baseline per hypothesis
  geom_hline(
    data = gw_baseline,
    aes(yintercept = f4ratio_gw),
    linetype = "dashed", linewidth = 0.5
  ) +
  coord_cartesian(ylim = c(0, ymax)) +
  facet_wrap(~ Hypothesis, nrow = 1) +
  labs(
    x = NULL, y = expression(f[4]*"-ratio (peak)"),
    caption = "Dashed line = genome-wide f4-ratio for the same hypothesis. Dot: q<0.05; Ring: 0.05≤q<0.10; Triangle shows sign of D."
  ) +
  theme_minimal(base_size = 11) +
  theme(
    panel.grid.major.x = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1),
    strip.text = element_text(face = "bold")
  )


```

```{r}
# ensure peak order and hypothesis order (adjust if yours differ)
peaks_df <- peaks_df %>%
  mutate(
    Peak = factor(Peak, levels = paste0("peak_", 1:6)),
    Hypothesis = factor(Hypothesis,
      levels = c("BP1↔BP2","BP1↔BP3","BP2↔BP3","BP1↔BP_ANC","BP2↔BP_ANC","BP3↔BP_ANC"))
  )

# one genome-wide baseline per hypothesis
gw_baseline <- peaks_df %>%
  group_by(Hypothesis) %>%
  summarize(f4ratio_gw = first(f4ratio_gw), .groups = "drop")

#ymax <- max(peaks_df$f4ratio, gw_baseline$f4ratio_gw, na.rm = TRUE) * 1.05
ymax<-1
ggplot(peaks_df, aes(x = Peak, y = f4ratio)) +
  geom_col(width = 0.7, alpha = 0.9) +
  # significance: filled dot for q<0.05, ring for 0.05–0.10
  geom_point(
    data = subset(peaks_df, q < 0.10),
    aes(y = f4ratio + 0.02 * ymax, shape = sig),
    size = 2.6, stroke = 0.7, fill = "white", color = "black"
  ) +
  scale_shape_manual(values = c("q<0.05" = 16, "q<0.10" = 1), guide = "none") +
  # direction of D as triangle at bar top (only for significant cells)
  geom_point(
    data = subset(peaks_df, q < 0.10 & dir == "pos"),
    aes(y = f4ratio + 0.06 * ymax), shape = 24, size = 2.2, fill = "white"
  ) +
  geom_point(
    data = subset(peaks_df, q < 0.10 & dir == "neg"),
    aes(y = f4ratio + 0.06 * ymax), shape = 25, size = 2.2, fill = "white"
  ) +
  # genome-wide baseline per hypothesis
  geom_hline(
    data = gw_baseline,
    aes(yintercept = f4ratio_gw),
    linetype = "dashed", linewidth = 0.5
  ) +
  coord_cartesian(ylim = c(0, ymax)) +
  facet_wrap(~ Hypothesis, nrow = 1) +
  labs(
    x = NULL, y = expression(f[4]*"-ratio (peak)"),
    caption = "Dashed line = genome-wide f4-ratio for the same hypothesis. Dot: q<0.05; Ring: 0.05≤q<0.10; Triangle shows sign of D."
  ) +
  theme_minimal(base_size = 11) +
  theme(
    panel.grid.major.x = element_blank(),
    axis.text.x = element_text(angle = 30, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

