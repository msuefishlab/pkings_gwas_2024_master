---
title: "Gene Expression Atlas for Paramormyrops kingsleyae"
output: html_notebook
---

```{r setup}
root <- rprojroot::find_root(".git/index")
knitr::opts_knit$set(root.dir = root)
library(tximport)
library(tximport)
library(GenomicFeatures)
library(DESeq2)
library(ggplot2)
library(pheatmap)
library(RColorBrewer)
library(stringr)
library(data.table)
library(circlize)
library(ComplexHeatmap)
library(txdbmaker)
library(dplyr)
library(matrixStats)
```


```{r}
samples <- read.table(file.path(root, "input_data/09_RNASeq/", "sample_table_for_kallisto.csv"), sep = ",", header = T)

paramormyrops_tx2gene <- read.csv(file.path(root, "input_data/09_RNASeq/", "paramormyrops_ncbi_0.4_tx2gene.csv"))

paramormyrops_tx2gene$X <- NULL

paramormyrops_files <- file.path(root, "output_data/09_RNASeq/atlas_data", samples$tissue, samples$species, samples$individual, "abundance.h5")

names(paramormyrops_files) <- paste0(samples$tissue, "_", samples$individual)

paramormyrops_data <- tximport(paramormyrops_files, type = "kallisto", tx2gene = paramormyrops_tx2gene, txOut = TRUE)
```

```{r}
dds <- DESeqDataSetFromTximport(paramormyrops_data, colData = samples, design = ~tissue)
round(colSums(assay(dds)) / 1e6, 1)
table(dds$tissue)
```

```{r}
keep <- rowSums(counts(dds) >= 5) >= 4
table(keep)
```

```{r}
dds <- dds[keep, ]
```

```{r}
boxplot(log10(counts(dds) + 1))
```

```{r}
dds <- estimateSizeFactors(dds)
boxplot(log10(counts(dds, normalized = TRUE) + 1))
normalized_counts <- counts(dds, normalized = TRUE)
```


```{r}
vsd <- vst(dds)

pcaData <- plotPCA(vsd, intgroup = c("individual", "tissue"), returnData = TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))
ggplot(pcaData, aes(x = PC1, y = PC2, color = tissue)) +
  geom_text(aes(label = tissue)) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  coord_fixed()
```

```{r, fig.height=12}
sampleDists <- dist(t(assay(vsd)))
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- paste(vsd$tissue, vsd$isolate, sep = "-")
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette(rev(brewer.pal(9, "Blues")))(255)
pheatmap(sampleDistMatrix,
  clustering_distance_rows = sampleDists,
  clustering_distance_cols = sampleDists,
  col = colors
)
```


```{r}
overlapping_annotations <- fread(file.path(root, "output_data/06_Association/PKINGS_ALL_WOB_EXCLUDED", "PKINGS_ALL_WOB_EXCLUDED_TRANSCRIPTS_IN_PEAKS_manual_annos_add.txt"))

df <- as.data.frame(colData(dds)[, c("tissue")])
colnames(df) <- "tissue"


custom_order <- c("EO", "HEART", "Muscle", "Spinal_Cord", "Brain", "Gill", "Kidney", "Spleen", "Swim_Bladder", "Ovary", "Testis", "Fin", "Flank_Skin", "Head_Skin")

col_fun <- colorRamp2(c(-4, -2, 0, 2, 4), c("blue", "lightblue", "white", "orange", "red"))
col_fun(seq(-4, 4))


## Get Peaks Data
peaks.file <- file.path(root, "output_data/06_Association/PKINGS_ALL_WOB_EXCLUDED/PKINGS_ALL_WOB_EXCLUDED_PEAKS.bed")
peaks.bed <- read.table(peaks.file)
names(peaks.bed) <- c("chrom", "start", "end", "peak", "idx_p", "idx_bp")
peaks.bed$chrom <- paste0("chr", peaks.bed$chrom)
peaks.bed <- peaks.bed[order(peaks.bed$peak), ]

gr_anno <- GRanges(
  overlapping_annotations$seqnames,
  IRanges(overlapping_annotations$start, overlapping_annotations$end)
)
gr_peaks <- GRanges(peaks.bed$chrom, IRanges(peaks.bed$start, peaks.bed$end))

## 1) exact overlaps
hits <- findOverlaps(gr_anno, gr_peaks, ignore.strand = TRUE)
peak_vec <- rep(NA_integer_, nrow(overlapping_annotations))
if (length(hits) > 0) {
  first_by_q <- tapply(subjectHits(hits), queryHits(hits), function(x) x[1])
  peak_vec[as.integer(names(first_by_q))] <- peaks.bed$peak[unlist(first_by_q)]
}

## 2) nearest fallback within 25 kb only where still NA
need <- which(is.na(peak_vec))
if (length(need)) {
  nearest_idx <- nearest(gr_anno[need], gr_peaks, select = "arbitrary")
  dists <- distance(gr_anno[need], gr_peaks[nearest_idx])
  use <- which(!is.na(nearest_idx) & dists <= 25000)
  peak_vec[need[use]] <- peaks.bed$peak[nearest_idx[use]]
}

## 3) assigned_name column
assigned_name <- ifelse(
  is.na(overlapping_annotations$manual_name) | overlapping_annotations$manual_name == "",
  overlapping_annotations$gene,
  overlapping_annotations$manual_name
)

## 4) final table
overlapping_with_peak <- cbind(
  overlapping_annotations,
  peak = peak_vec,
  assigned_name = assigned_name
)
```

```{r, fig.width=18}

tx_abs_expr <- as.matrix(paramormyrops_data$abundance) # genes x samples (TPM)
tx_abs_expr <- tx_abs_expr[, colnames(dds), drop = FALSE] # align sample order

## -----------------------------------------------------------
## 1) Tissue ordering (unchanged)
## -----------------------------------------------------------
tissue_fac <- factor(df$tissue, levels = custom_order)
ord_cols <- order(tissue_fac)

## -----------------------------------------------------------
## 2) Build transcript â†” gene/peak mapping from your overlap table
##     - Use overlapping_with_peak$ID as the transcript label to display
##     - Group by gene (assigned_name fallback) and by peak
##     - Make matching robust to version suffixes in transcript IDs
## -----------------------------------------------------------
overlap_tbl <- overlapping_with_peak %>%
  mutate(
    transcript_label = trimws(as.character(ID)),  # what you want to DISPLAY
    gene_symbol = trimws(as.character(dplyr::coalesce(assigned_name, gene))),
    peak = as.integer(peak)
  ) %>%
  filter(!is.na(transcript_label), transcript_label != "")

# Some quant tools keep versioned transcript rownames (XM_XXXXX.2); normalize both sides
strip_ver <- function(x) sub("\\.\\d+$", "", x)
tx_rownames <- rownames(tx_abs_expr)
tx_rownames_nov <- strip_ver(tx_rownames)

# Try to match by exact first, then by versionless
overlap_tbl <- overlap_tbl %>%
  mutate(
    tr_exact_hit = match(transcript_label, tx_rownames),
    tr_nov_hit   = match(strip_ver(transcript_label), tx_rownames_nov),
    expr_row_idx = ifelse(!is.na(tr_exact_hit), tr_exact_hit, tr_nov_hit)
  ) %>%
  filter(!is.na(expr_row_idx)) %>%
  mutate(expr_row_id = tx_rownames[expr_row_idx]) %>%
  distinct(expr_row_id, transcript_label, gene_symbol, peak)

sel_ids <- intersect(overlap_tbl$expr_row_id, rownames(tx_abs_expr))
stopifnot(length(sel_ids) > 0)
overlap_tbl <- overlap_tbl %>% filter(expr_row_id %in% sel_ids)

## -----------------------------------------------------------
## 3) EO absolute-expression metrics on transcripts
## -----------------------------------------------------------
eo_idx <- which(df$tissue == "EO")
eo_expr <- tx_abs_expr[, eo_idx, drop = FALSE]
eo_med <- matrixStats::rowMedians(eo_expr, na.rm = TRUE)
eo_n_ge1 <- rowSums(eo_expr >= 1)
eo_n_ge5 <- rowSums(eo_expr >= 5)

eo_abs_df <- data.frame(
  expr_row_id = rownames(eo_expr),
  EO_median   = eo_med,
  EO_n_ge1    = eo_n_ge1,
  EO_n_ge5    = eo_n_ge5,
  EIE_loose   = eo_med >= 1 & eo_n_ge1 >= 2,
  EIE_strict  = eo_med >= 2.5 & eo_n_ge5 >= 2,
  check.names = FALSE
)

## -----------------------------------------------------------
## 4) Lookups for ordering/annotations (by transcript now)
## -----------------------------------------------------------
peak_by_id   <- setNames(overlap_tbl$peak, overlap_tbl$expr_row_id)
label_by_id  <- setNames(overlap_tbl$transcript_label, overlap_tbl$expr_row_id)  # rownames in heatmap
gene_by_id   <- setNames(overlap_tbl$gene_symbol, overlap_tbl$expr_row_id)

EO_median_by_id   <- setNames(eo_abs_df$EO_median, eo_abs_df$expr_row_id)
EIE_strict_by_id  <- setNames(eo_abs_df$EIE_strict, eo_abs_df$expr_row_id)
EIE_loose_by_id  <- setNames(eo_abs_df$EIE_loose, eo_abs_df$expr_row_id)

is_eo <- as.integer(EIE_loose_by_id[sel_ids]); is_eo[is.na(is_eo)] <- 0
eo_medkey <- EO_median_by_id[sel_ids]; eo_medkey[is.na(eo_medkey)] <- -Inf

peak_levels <- sort(unique(overlap_tbl$peak))
# Order: by peak, then by gene, then EO-strict yes first, then EO median desc, then transcript label
ord_rows <- order(
  factor(peak_by_id[sel_ids], levels = peak_levels),
  gene_by_id[sel_ids],
  -is_eo,
  -eo_medkey,
  label_by_id[sel_ids]
)
sel_ids_ord <- sel_ids[ord_rows]

## -----------------------------------------------------------
## 5) Plotting matrix and row splits (split by Peak and by Gene)
## -----------------------------------------------------------
mat_abs <- log2(tx_abs_expr[sel_ids_ord, colnames(dds), drop = FALSE] + 1)
mat_abs <- mat_abs[, ord_cols, drop = FALSE]
rownames(mat_abs) <- label_by_id[sel_ids_ord]   # <-- show transcript ID

row_split_df <- data.frame(
  Peak = factor(peak_by_id[sel_ids_ord], levels = peak_levels),
  Gene = factor(gene_by_id[sel_ids_ord]),
  row.names = rownames(mat_abs),
  check.names = FALSE
)

row_df <- data.frame(
  `EO-expressed` = ifelse(EIE_loose_by_id[sel_ids_ord], "yes", "no"),
  row.names = rownames(mat_abs),
  check.names = FALSE
)

row_ann <- ComplexHeatmap::rowAnnotation(
  df  = row_df,
  col = list(`EO-expressed` = c("no" = "#d3d3d3", "yes" = "#1ea8e0")),
  gp  = grid::gpar(col = NA)
)

## -----------------------------------------------------------
## 6) Color function (kept your warm-biased quantile mapping)
## -----------------------------------------------------------
qs <- as.numeric(quantile(as.vector(mat_abs), probs = c(0, .20, .40, .70, .95), na.rm = TRUE))
col_fun_abs <- circlize::colorRamp2(
  qs,
  c("#ffffff", "#fff5eb", "#fdd0a2", "#f16913", "#b30000")
)

## -----------------------------------------------------------
## 7) Draw the heatmap
##    - No clustering; columns split by tissue; rows split by Peak and Gene
## -----------------------------------------------------------
ht <- ComplexHeatmap::Heatmap(
  mat_abs,
  name = "log2(TPM+1)",
  col = col_fun_abs,
  show_row_names = TRUE,
  row_names_gp = grid::gpar(fontsize = 9),
  show_column_names = FALSE,
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  row_split = row_split_df,             # <-- split by Peak then Gene
  row_title_rot = 0,
  row_title_gp = grid::gpar(fontsize = 9, fontface = "bold"),
  column_split = tissue_fac[ord_cols],
  column_gap = grid::unit(2, "mm"),
  row_gap = grid::unit(1.5, "mm"),
  border = FALSE,
  left_annotation = row_ann
)

ComplexHeatmap::draw(ht, heatmap_legend_side = "right", annotation_legend_side = "right")

## -----------------------------------------------------------
## 8) Export ranked table (now per transcript)
## -----------------------------------------------------------
out_tbl <- data.frame(
  transcript_id = label_by_id[sel_ids_ord],
  gene = gene_by_id[sel_ids_ord],
  peak = as.integer(peak_by_id[sel_ids_ord]),
  EO_median = EO_median_by_id[sel_ids_ord],
  EO_expressed_strict = as.logical(EIE_loose_by_id[sel_ids_ord]),
  stringsAsFactors = FALSE,
  check.names = FALSE
)
write.table(out_tbl,
  file.path(root, "output_data/09_RNASeq/peak_transcripts_EO_absolute_expression.tsv"),
  sep = "\t", quote = FALSE, row.names = FALSE
)

```
